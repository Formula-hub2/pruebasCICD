name: Deploy on Webhook

on:
  workflow_run:
    workflows: ["Pytest"]
    types:
      - completed

jobs:
  deploy:
    # Solo ejecutamos si los tests pasaron y es un push a main
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-24.04

    steps:
      # 1. Disparar el despliegue en Render usando la URL nativa
      - name: Trigger Render Deployment
        if: success()
        run: |
          if [ -z "${{ secrets.WEBHOOK_DOMAIN }}" ]; then
            echo "ERROR: No has configurado el secreto WEBHOOK_DOMAIN"
            exit 1
          fi
          # La URL completa ya incluye la autenticaciÃ³n
          curl -X POST "${{ secrets.WEBHOOK_DOMAIN }}"

      # 2. Notificar Ã‰XITO a Discord
      - name: Discord Notification - Success
        if: success()
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: 'ðŸš€ **Despliegue Iniciado!** Render ha recibido la orden de actualizar la versiÃ³n en `main`.'

      # 3. Notificar FALLO a Discord
      - name: Discord Notification - Failure
        if: failure()
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: 'ðŸš¨ **Error en Despliegue:** No se pudo contactar con el Deploy Hook de Render.'
